---
name: CMake

on:
    - push

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
    cancel-in-progress: true

env:
    CMAKE_UNITY_BUILD: OFF

permissions:
    contents: read

jobs:

    build-cmake:
        runs-on: ubuntu-22.04
        env:
            PythonVersion: "3.12"
            CMakeVersion: "3.16.8"
        steps:
            - name: Checkout GRASS
              uses: actions/checkout@v4.1.1
            - name: Set up Python
              uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 # v5.4.0
              with:
                  python-version: ${{ env.PythonVersion }}
            - name: Install dependencies
              run: |
                sudo apt-get update -y
                sudo apt-get install -y wget git gawk findutils
                xargs -a <(awk '! /^ *(#|$)/' ".github/workflows/apt.txt") -r -- \
                    sudo apt-get install -y --no-install-recommends --no-install-suggests
            - name: Install Python packages
              run: python -m pip install ninja cmake==${{ env.CMakeVersion }}
              working-directory: ${{ github.workspace }}
            - name: Print build environment variables
              shell: bash -el {0}
              run: |
                printenv | sort
                gcc --version
                ldd --version
                cmake --version
            - name: Create installation directory
              run: |
                mkdir $HOME/install
            - name: Configure
              run: |
                cmake ${CMAKE_OPTIONS} -S $GITHUB_WORKSPACE -B $GITHUB_WORKSPACE/build -G Ninja \
                  -DCMAKE_C_FLAGS="-I/usr/include -I/usr/include/gdal" \
                  -DCMAKE_CXX_FLAGS="-I/usr/include -I/usr/include/gdal" \
                  -DCMAKE_INSTALL_PREFIX=$HOME/install -DWITH_NLS=OFF -DWITH_GUI=OFF -DWITH_DOCS=OFF
            - name: Print CMakeCache.txt
              shell: bash -el {0}
              run: |
                cat ${GITHUB_WORKSPACE}/build/CMakeCache.txt
            - name: Build
              run: |
                cmake --build build --verbose -j$(nproc)
            - name: Install
              run: |
                cmake --install $GITHUB_WORKSPACE/build --verbose
            - name: Add the bin directory to PATH
              run: |
                echo "$HOME/install/bin" >> $GITHUB_PATH
            - name: Print installed versions
              if: always()
              run: .github/workflows/print_versions.sh
            - name: Test executing of the grass command
              run: .github/workflows/test_simple.sh
            - name: Run tests
              run: .github/workflows/test_thorough.sh --config .gunittest.cfg
